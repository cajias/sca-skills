name: Publish Packages

on:
  push:
    tags:
      - 'v*'  # Trigger on version tags like v1.0.0
  workflow_dispatch:  # Allow manual triggering

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Required for creating releases
      packages: write  # Required for publishing to GitHub Packages
      id-token: write  # Required for trusted publishing

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Python Package Build
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: Install Python build tools
        run: |
          python -m pip install --upgrade pip
          pip install build twine

      - name: Build Python package
        run: |
          cd python
          python -m build
          ls -la dist/

      - name: Check Python package
        run: |
          cd python
          twine check dist/*

      # TypeScript/JavaScript Package Build
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Build TypeScript package
        run: |
          cd typescript
          npm ci --ignore-scripts
          echo "ðŸ“¦ Built TypeScript package"
          ls -la

      - name: Build Markdown package
        run: |
          cd markdown
          npm ci --ignore-scripts || echo "No dependencies to install"
          echo "ðŸ“¦ Built Markdown package"
          ls -la

      - name: Create npm tarballs
        run: |
          cd typescript
          TARBALL=$(npm pack)
          mv "$TARBALL" ../
          cd ../markdown
          TARBALL=$(npm pack)
          mv "$TARBALL" ../
          cd ..
          echo "ðŸ“¦ Created tarballs:"
          ls -la *.tgz

      # Publish Python to PyPI
      - name: Publish Python to PyPI (Optional)
        # Only publish to PyPI if PYPI_API_TOKEN secret is set
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
        continue-on-error: true
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
        run: |
          cd python
          twine upload dist/*
          echo "âœ… Published Python package to PyPI!"

      # Publish TypeScript to npm
      - name: Publish TypeScript to npm (Optional)
        # Only publish to npm if NPM_TOKEN secret is set
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
        continue-on-error: true
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          cd typescript
          npm publish --access public
          echo "âœ… Published TypeScript package to npm!"

      # Publish TypeScript to GitHub Packages
      - name: Set up Node.js for GitHub Packages
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://npm.pkg.github.com'
          scope: '@sca-skills'

      - name: Publish TypeScript to GitHub Packages
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
        continue-on-error: true
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cd typescript
          npm publish
          echo "âœ… Published TypeScript package to GitHub Packages!"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/v')
        with:
          files: |
            python/dist/*
            *.tgz
          generate_release_notes: true
          body: |
            ## ðŸ“¦ Lint Configurations Release
            
            This release packages canonical linting configurations for multiple languages.

            ## Installation

            ### Python
            ```bash
            # Install from PyPI (if published)
            pip install sca-skills

            # Or install from Git
            pip install git+https://github.com/${{ github.repository }}.git@${{ github.ref_name }}#subdirectory=python
            ```

            See [Python README](https://github.com/${{ github.repository }}/tree/${{ github.ref_name }}/python) for usage.

            ### TypeScript/JavaScript
            ```bash
            # Install from npm (if published)
            npm install @sca-skills/eslint-config
            npm install @sca-skills/markdownlint-config

            # Install from release tarballs (replace version numbers with actual versions from release assets)
            npm install https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/sca-skills-eslint-config-1.0.2.tgz
            npm install https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/sca-skills-markdownlint-config-1.0.0.tgz

            # Or install from Git
            npm install git+https://github.com/${{ github.repository }}.git#subdirectory=typescript
            npm install git+https://github.com/${{ github.repository }}.git#subdirectory=markdown
            ```

            See [TypeScript README](https://github.com/${{ github.repository }}/tree/${{ github.ref_name }}/typescript) and [Markdown README](https://github.com/${{ github.repository }}/tree/${{ github.ref_name }}/markdown) for usage.

            ## What's Included

            **Python Package:**
            - Ruff (40+ rule categories)
            - MyPy (strict type checking)
            - Black (code formatting)
            - Pylint (duplicate code detection)
            - Coverage (80% minimum)

            **TypeScript/JavaScript Package:**
            - ESLint (200+ rules from multiple plugins)
            - TypeScript strict mode
            - Prettier (code formatting)
            - Security, complexity, and dead code detection

            ## What's Changed
            See the full changelog in the commits below.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Display installation instructions
        run: |
          echo "::notice::âœ… Packages published to GitHub Release!"
          echo "::notice::ðŸ“¦ Version: ${GITHUB_REF#refs/tags/}"
          echo "::notice::Python: pip install git+https://github.com/${{ github.repository }}.git@${GITHUB_REF#refs/tags/}#subdirectory=python"
          echo "::notice::TypeScript: npm install @sca-skills/eslint-config@${GITHUB_REF#refs/tags/}"
